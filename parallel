#!/bin/bash
#SBATCH --job-name=parallel
#SBATCH -N 2
#SBATCH --ntasks=30
#SBATCH --partition=lirmm1
#SBATCH --time=00:10:00
#SBATCH -o parallel.out   # File to which STDOUT will be written, including job ID

if [[ $# < 2 ]]; then
	echo "Usage : $0 [EXECUTABLE] [DONNEES]"
	exit
fi

echo "Running on: $SLURM_NODELIST"

STARTTIME=$(date +%s.%N)

for arg do
	if [[ "$arg" > "1" && "$arg" != "$1" ]]; then
		
		JOBSTARTTIME=$(date +%s.%N)
		
		srun -n 1 --exclusive $1 $arg &
		
		JOBENDTIME=$(date +%s.%N)
		
		TIMEDIFF=$(echo "$JOBENDTIME - $JOBSTARTTIME" | bc | awk -F"." '{print $1"."substr($2,1,3)}')
		
		echo "%j Done in : $TIMEDIFF"
	fi
done

wait

ENDTIME=$(date +%s.%N)

TIMEDIFF=$(echo "$ENDTIME - $STARTTIME" | bc | awk -F"." '{print $1"."substr($2,1,3)}')

echo "All jobs done !"

echo "total time : $TIMEDIFF" 
